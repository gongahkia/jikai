# jikai — audit-driven improvement tasks
# Priority (B) = audit-suggested. Ordered by impact, grouped by concern.




## error handling hardening

[ ] rate limiter memory bound: in api/main.py RateLimiterMiddleware, add a max of 10000 tracked IPs — when exceeded, evict the oldest IP bucket. prevents memory exhaustion from IP rotation attacks +security
[ ] specific exception types: in hypothetical_service.py line 16, replace bare except Exception with except (ImportError, ModuleNotFoundError) for the corpus_service import — lets genuine errors propagate +stability
[ ] specific exception types: in hypothetical_service.py _get_ml_pipeline (line 86), replace bare except Exception with except (ImportError, FileNotFoundError) — same rationale +stability
[ ] vector service init exception: in vector_service.py _initialize, replace bare except Exception (line 75) with except (ImportError, OSError, RuntimeError) to catch expected failures while letting unexpected ones propagate +stability
[ ] log auth failures: in api/main.py APIKeyMiddleware.dispatch, add logger.warning("auth_failure", path=request.url.path, client_ip=client_ip) when API key validation fails +security
[ ] log rate limit hits: in api/main.py RateLimiterMiddleware.dispatch, add logger.warning("rate_limited", client_ip=client_ip) when rate limit exceeded +security

## performance (minor for single-user, but prevents UX lag)

[ ] cache status bar data: in rich_app.py _render_status_bar, cache the result of _load_history() for 5 seconds (store last_history_load_time and cached_last_score as instance vars) — avoids reading history.json on every menu loop iteration +perf
[ ] lazy vector service init: in vector_service.py, do NOT call self._initialize() in __init__. Instead, initialize on first call to semantic_search() or index_hypotheticals(). Prevents 2-5s startup delay when vector search isn't used +perf

## API robustness

[ ] batch item validation: in api/main.py batch_generate, validate each BatchGenerateConfig.topic against available topics before processing — return 400 with specific errors instead of 500 during generation +stability
[ ] export endpoint file cleanup: in api/main.py export_generation, use tempfile.NamedTemporaryFile(delete=False) and register a background task to delete the temp file after response is sent — prevents temp file accumulation +stability
[ ] export endpoint history bounds: in api/main.py export_generation, return 400 if format is not "docx" or "pdf" (already done) AND validate history_id is a non-negative integer — add explicit type validation +stability

## code quality

[ ] normalize topic keys: add a helper function normalize_topic(topic: str) -> str that does topic.lower().replace("_", " ").strip() — use it consistently in validation_service topic lookups, template case loading, and history filtering to eliminate the underscore/space mismatch bug +refactor
[ ] extract generation config dataclass: in rich_app.py, create a GenerationConfig dataclass (topic, provider, model, temperature, complexity, parties, method, red_herrings) to replace the 8-parameter _do_generate signature and the scattered dict construction for history/state +refactor
